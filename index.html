function onEdit(e) {
  if (e && e.range) {
    var sheet = e.range.getSheet();
    var range = e.range;
    
    // הגדרת רקע אדום בהיר לשורה 3
    sheet.getRange("A3:F3").setBackground("#FFCCCB");
    
    // טיפול בעדכון בעמודה A
    if (range.getColumn() == 1 && range.getRow() >= 3) {
      var row = range.getRow();
      var dateCell = sheet.getRange(row, 2);
      var timeCell = sheet.getRange(row, 3);
      
      if (dateCell.getValue() === "" && timeCell.getValue() === "") {
        var now = new Date();
        // שימוש באזור הזמן של המחשב המקומי
        var timeZone = Session.getScriptTimeZone();
        dateCell.setValue(Utilities.formatDate(now, timeZone, "dd/MM/yyyy"));
        timeCell.setValue(Utilities.formatDate(now, timeZone, "HH:mm:ss"));
      }
      
      // העתקת שם המדווח ושם היומן
      var reporterCell = sheet.getRange(row, 4);
      var journalCell = sheet.getRange(row, 5);
      
      if (reporterCell.getValue() === "") {
        reporterCell.setValue(sheet.getRange("D4").getValue());
      }
      
      if (journalCell.getValue() === "") {
        journalCell.setValue(sheet.getRange("E4").getValue());
      }
      
      // הזזת השורה החדשה לשורה 4 ושמירת העיצוב
      if (row == 3) {
        sheet.insertRowAfter(3);
        var sourceRange = sheet.getRange("A3:F3");
        var targetRange = sheet.getRange("A4:F4");
        sourceRange.copyTo(targetRange, {contentsOnly: false});
        sourceRange.clearContent();
        
        // שמירת העיצוב של שורה 4 המקורית
        var originalFormatRange = sheet.getRange("A5:F5");
        originalFormatRange.copyFormatToRange(sheet, 1, 6, 4, 4);
      }
      
      // מיון הטבלה
      var lastRow = sheet.getLastRow();
      if (lastRow > 4) {
        var dataRange = sheet.getRange("A4:F" + lastRow);
        dataRange.sort([{column: 2, ascending: false}, {column: 3, ascending: false}]);
      }
      
      // החזרת הסמן לתא A3
      sheet.getRange("A3").activate();
    }
  }
}

function onOpen() {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var timeZone = Session.getScriptTimeZone();
  
  // הגדרת שורות כותרת
  sheet.getRange("1:2").setFontWeight("bold");
  
  // הוספת שעון דיגיטלי עם אזור זמן מקומי
  sheet.getRange("E1:F1").merge()
    .setValue('=TEXT(NOW(), "HH:mm")')
    .setFontColor("red")
    .setFontWeight("bold")
    .setHorizontalAlignment("center");
  
  // הגדרת רקע אדום בהיר לשורה 3
  sheet.getRange("A3:F3").setBackground("#FFCCCB");
}
