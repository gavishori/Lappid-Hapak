<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>יומן חפ"ק - לפיד</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: A single-page, task-oriented application designed for efficient data entry and management. The primary input area now features all core input elements (report description, reporter, log type, and action buttons) arranged horizontally on larger screens for compact and efficient interaction. On smaller screens, these elements gracefully stack vertically to maintain usability. This consolidated input block is followed by the main content area displaying the data table, providing direct 'Edit' and 'Delete' actions for each entry. This streamlined structure prioritizes a clear and intuitive user flow for managing reports. -->
    <!-- Visualization & Content Choices: Report Data -> Goal: Input/Manage -> Presentation: Consolidated HTML Form (for add/edit) & HTML Table (for display) -> Interaction: Users input data into the primary form fields. The main action button toggles between 'הזן' (Add) and 'עדכן דיווח' (Update) based on whether an existing report is being edited. Clicking 'Edit' next to a table row populates the form and switches the button to 'Update'. Clicking 'Delete' removes a row. Justification: A compact, horizontally-aligned input form enhances data entry speed for frequent tasks on wider screens, while responsive stacking ensures mobile usability. The table provides clear data overview and direct management actions. Library/Method: Vanilla JS for DOM manipulation and state management, Tailwind CSS for styling and responsive layout. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #FDFBF7;
        }
        .table-cell {
            padding: 12px 16px;
            text-align: right;
            border-bottom: 1px solid #EAE2D9;
            vertical-align: middle;
        }
        .form-input, .form-select, .form-textarea {
            border-color: #DCD5CC;
            transition: all 0.3s ease;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: #B8A692;
            box-shadow: 0 0 0 2px rgba(184, 166, 146, 0.2);
            outline: none;
        }
        .btn-primary {
            background-color: #8C7A6B;
            color: #FFFFFF;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #736357;
        }
        .btn-secondary {
            background-color: #EAE2D9;
            color: #6D5F53;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #DCD5CC;
        }
    </style>
</head>
<body class="bg-[#FDFBF7] text-[#4A443E]">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">

        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-[#6D5F53]">יומן חפ"ק - לפיד</h1>
        </header>

        <main class="bg-white rounded-xl shadow-lg p-6 ring-1 ring-[#EAE2D9]">
            <div class="controls-section mb-6 pb-6 border-b border-[#EAE2D9]">
                
                <!-- Main Input and Action Area - Now consolidated to a single row concept -->
                <div class="max-w-full mx-auto mb-6 p-4 bg-[#F8F5F1] rounded-lg shadow-inner">
                    <div class="flex flex-col sm:flex-row items-end gap-4">
                        <div class="flex-grow w-full sm:w-auto"> <!-- Textarea takes primary space -->
                            <label for="generalTextInput" class="block mb-1 text-sm font-semibold text-[#6D5F53]">תיאור דיווח:</label>
                            <textarea id="generalTextInput" class="form-textarea w-full p-2 border rounded-md" rows="2" placeholder="פרטי דיווח קצרים..."></textarea>
                        </div>
                        
                        <div class="flex-shrink-0 w-full sm:w-auto"> <!-- Reporter dropdown -->
                            <label for="filterReporter" class="block mb-1 text-sm font-semibold text-[#8C7A6B]">מדווח:</label>
                            <select id="filterReporter" class="form-select w-full p-2.5 bg-white border rounded-lg shadow-sm">
                                <option value="אורי">אורי</option>
                                <option value="שונית">שונית</option>
                                <option value="חיליק">חיליק</option>
                            </select>
                        </div>
                        
                        <div class="flex-shrink-0 w-full sm:w-auto"> <!-- Log Type dropdown -->
                            <label for="filterLogType" class="block mb-1 text-sm font-semibold text-[#8C7A6B]">שיוך:</label>
                            <select id="filterLogType" class="form-select w-full p-2.5 bg-white border rounded-lg shadow-sm">
                                <option value="שגרה">שגרה</option>
                                <option value="שריפה">שריפה</option>
                                <option value="אחר">אחר</option>
                            </select>
                        </div>
                        
                        <!-- Visible Date and Time Inputs -->
                        <div class="flex-shrink-0 w-full sm:w-auto">
                            <label for="newDate" class="block mb-1 text-sm font-semibold text-[#6D5F53]">תאריך:</label>
                            <input type="date" id="newDate" class="form-input w-full p-2 border rounded-md">
                        </div>
                        <div class="flex-shrink-0 w-full sm:w-auto">
                            <label for="newTime" class="block mb-1 text-sm font-semibold text-[#6D5F53]">שעה (24H):</label>
                            <input type="text" id="newTime" class="form-input w-full p-2 border rounded-md" placeholder="HH:MM" pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]">
                        </div>

                        <div class="flex-shrink-0 w-full sm:w-auto flex flex-row sm:flex-col items-end gap-2"> <!-- Action buttons -->
                            <button id="mainActionBtn" class="btn-primary font-bold py-2 px-6 rounded-lg shadow w-full sm:w-auto">הזן</button>
                            <button id="cancelEditBtn" class="btn-secondary font-bold py-2 px-6 rounded-lg shadow w-full sm:w-auto hidden">ביטול</button>
                        </div>
                    </div>
                    <div id="inputErrorMessage" class="text-red-500 text-center mt-4 h-5"></div>
                </div>

                <!-- The original hidden date and time inputs div is removed -->
                <!-- The original filter dropdowns div is removed as they are now part of the main input area -->
            </div>

            <div class="table-container overflow-x-auto">
                 <p class="text-md text-[#6D5F53] mb-4">זוהי טבלת הדיווחים. כל דיווח חדש שיתווסף או יעודכן יופיע כאן באופן מיידי.</p>
                <table class="w-full min-w-full text-sm">
                    <thead class="bg-[#F8F5F1]">
                        <tr>
                            <th class="table-cell font-bold text-[#6D5F53]">דיווח</th>
                            <th class="table-cell font-bold text-[#6D5F53]">תאריך</th>
                            <th class="table-cell font-bold text-[#6D5F53]">שעה</th>
                            <th class="table-cell font-bold text-[#6D5F53]">שם המדווח</th>
                            <th class="table-cell font-bold text-[#6D5F53]">שיוך יומן</th>
                            <th class="table-cell font-bold text-[#6D5F53]">פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <tr id="empty-state">
                            <td colspan="6" class="table-cell text-center text-gray-500 py-8">לא נוספו דיווחים עדיין.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const filterReporter = document.getElementById('filterReporter');
            const filterLogType = document.getElementById('filterLogType');
            
            const generalTextInput = document.getElementById('generalTextInput');
            const newDateInput = document.getElementById('newDate'); 
            const newTimeInput = document.getElementById('newTime'); 

            const mainActionBtn = document.getElementById('mainActionBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const tableBody = document.getElementById('reportTableBody');
            const emptyStateRow = document.getElementById('empty-state');
            const inputErrorMessage = document.getElementById('inputErrorMessage');

            let reports = [];
            let editingReportIndex = null; // null when adding, index when editing

            // Sets default date and time in the input fields
            const setDefaultDateTime = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                newDateInput.value = `${year}-${month}-${day}`;
                
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                newTimeInput.value = `${hours}:${minutes}`; // Ensures 24H format for default
            };
            
            // Function to validate time format (HH:MM)
            const isValidTimeFormat = (timeString) => {
                const pattern = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
                return pattern.test(timeString);
            };

            // Function to sort reports by date (descending) then time (descending)
            const sortReports = () => {
                reports.sort((a, b) => {
                    // Compare dates (descending)
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);

                    if (dateA > dateB) return -1; // b comes before a for descending date
                    if (dateA < dateB) return 1;  // a comes before b for descending date

                    // If dates are equal, compare times (descending)
                    // Ensure time is compared as strings lexicographically for HH:MM format
                    if (a.time > b.time) return -1; 
                    if (a.time < b.time) return 1;  

                    return 0; // Objects are equal
                });
            };

            // Renders the table content based on the reports array
            const renderTable = () => {
                tableBody.innerHTML = '';
                if (reports.length === 0) {
                    tableBody.appendChild(emptyStateRow);
                } else {
                    reports.forEach((report, index) => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-[#F8F5F1]';
                        row.innerHTML = `
                            <td class="table-cell">${report.description.replace(/\n/g, '<br>')}</td>
                            <td class="table-cell">${new Date(report.date).toLocaleDateString('he-IL')}</td>
                            <td class="table-cell">${report.time}</td>
                            <td class="table-cell">${report.reporter}</td>
                            <td class="table-cell">${report.logType}</td>
                            <td class="table-cell text-center whitespace-nowrap">
                                <button data-index="${index}" class="text-blue-600 hover:text-blue-800 font-semibold edit-btn">ערוך</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            };

            // Clears the input fields and resets the form to "add new report" mode
            const resetForm = () => {
                generalTextInput.value = '';
                setDefaultDateTime(); 
                generalTextInput.focus();
                editingReportIndex = null;
                mainActionBtn.textContent = 'הזן';
                cancelEditBtn.classList.add('hidden');
                inputErrorMessage.textContent = '';
            };

            // Adds a new report
            const addReport = () => {
                const description = generalTextInput.value.trim();
                const date = newDateInput.value;
                const time = newTimeInput.value;
                const reporter = filterReporter.value; // Get from dropdown
                const logType = filterLogType.value;   // Get from dropdown

                if (!description || !date || !time) {
                    inputErrorMessage.textContent = 'יש למלא את כל השדות: תיאור, תאריך ושעה.';
                    setTimeout(() => inputErrorMessage.textContent = '', 3000);
                    return;
                }
                if (!isValidTimeFormat(time)) {
                    inputErrorMessage.textContent = 'פורמט שעה שגוי. אנא הזן HH:MM (לדוגמה, 14:30).';
                    setTimeout(() => inputErrorMessage.textContent = '', 3000);
                    return;
                }

                reports.push({ description, date, time, reporter, logType });
                sortReports(); // Sort after adding
                renderTable();
                resetForm(); // Reset form after adding
            };

            // Updates an existing report
            const updateReport = () => {
                const description = generalTextInput.value.trim();
                const date = newDateInput.value;
                const time = newTimeInput.value;
                const reporter = filterReporter.value; // Get from dropdown
                const logType = filterLogType.value;   // Get from dropdown

                if (!description || !date || !time) {
                    inputErrorMessage.textContent = 'יש למלא את כל השדות: תיאור, תאריך ושעה.';
                    setTimeout(() => inputErrorMessage.textContent = '', 3000);
                    return;
                }
                if (!isValidTimeFormat(time)) {
                    inputErrorMessage.textContent = 'פורמט שעה שגוי. אנא הזן HH:MM (לדוגמה, 14:30).';
                    setTimeout(() => inputErrorMessage.textContent = '', 3000);
                    return;
                }

                if (editingReportIndex !== null) {
                    reports[editingReportIndex] = { description, date, time, reporter, logType };
                    sortReports(); // Sort after updating
                    renderTable();
                    resetForm(); // Reset form after updating
                }
            };

            // Handles the click on the main action button (Add/Update)
            mainActionBtn.addEventListener('click', () => {
                if (editingReportIndex === null) {
                    addReport();
                } else {
                    updateReport();
                }
            });

            // Handles the click on the cancel edit button
            cancelEditBtn.addEventListener('click', resetForm);
            
            // Event delegation for table actions (edit)
            tableBody.addEventListener('click', (e) => {
                // Edit button
                if (e.target.classList.contains('edit-btn')) {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    const reportToEdit = reports[index];
                    
                    // Populate inputs with report data
                    generalTextInput.value = reportToEdit.description;
                    newDateInput.value = reportToEdit.date;
                    newTimeInput.value = reportToEdit.time; // This will now correctly populate HH:MM into text input
                    filterReporter.value = reportToEdit.reporter; // Update dropdown
                    filterLogType.value = reportToEdit.logType;   // Update dropdown
                    
                    editingReportIndex = index; // Set editing mode
                    mainActionBtn.textContent = 'עדכן דיווח'; // Change button text
                    cancelEditBtn.classList.remove('hidden'); // Show cancel button
                    generalTextInput.focus(); // Focus on description for editing
                }
            });

            // Initialize default date and time, and render table on load
            setDefaultDateTime();
            sortReports(); 
            renderTable();
        });
    </script>
</body>
</html>
