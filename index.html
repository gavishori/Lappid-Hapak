<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>שלד טבלה</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the table to match the image's appearance */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column; /* Stack header, input area, and table vertically */
            justify-content: flex-start;
            align-items: center; /* Center content horizontally */
            min-height: 100vh;
            padding: 20px;
        }
        .table-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow-x: auto; /* Allows horizontal scrolling on small screens if content overflows */
            width: 100%;
            max-width: 1200px;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed; /* Ensures column widths are respected */
        }
        th, td {
            padding: 12px 16px;
            text-align: right;
            border-bottom: 1px solid #e2e8f0;
            position: relative; /* Needed for absolute positioning of cell numbers */
            vertical-align: top; /* Align content to the top of the cell */
            box-sizing: border-box; /* Include padding in width calculations */
        }
        th {
            background-color: #ffe0e6; /* Light pink background for headers */
            color: #333;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap; /* Keep headers on one line */
        }
        td {
            white-space: normal; /* Allow text wrapping within data cells */
        }
        tr:nth-child(even) {
            background-color: #f8faff; /* Light blueish background for even rows */
        }
        tr:hover {
            background-color: #f0f4f8; /* Hover effect for rows */
        }
        .header-top-left {
            background-color: #ffcc00; /* Yellow background for "הערכת מצב בשעה" */
            color: #000;
            font-weight: bold;
            text-align: center;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px; /* Space below header */
            width: 100%; /* Full width */
            max-width: 1200px; /* Match table max-width */
            position: relative; /* Needed for absolute positioning of cell number */
        }
        .dropdown-cell {
            position: relative;
        }
        .dropdown-cell select {
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: #e0f2fe; /* Light blue background for dropdowns */
            border: 1px solid #90cdf4;
            border-radius: 6px;
            padding: 8px 30px 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #2c5282;
            width: 100%;
            min-width: 100px; /* Reduced min-width for mobile flexibility */
        }
        .dropdown-cell select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }
        .dropdown-cell::after {
            content: '▼'; /* Custom dropdown arrow */
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            pointer-events: none;
            color: #2c5282;
        }
        /* Style for displaying cell numbers */
        .cell-number {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.7em;
            color: #888;
            padding: 1px 4px;
            border-radius: 4px;
            z-index: 1;
        }
        /* Style for input fields and textareas within cells */
        .cell-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 0.9rem;
            resize: vertical; /* Allow vertical resizing, but not horizontal */
            min-height: 38px; /* Ensure consistent height with single-line input */
            vertical-align: top; /* Align text to the top for multi-line */
            white-space: normal; /* Allow text wrapping within textarea */
        }
        .cell-input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }

        /* Responsive Column Widths and Visibility for table rows (default is desktop) */
        .col-description { width: 30%; }
        .col-date { width: 15%; }
        .col-time { width: 15%; }
        .col-reporter { width: 20%; }
        .col-journal { width: 20%; }

        /* Specific styling for the separate input form area */
        .input-form-area {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 16px;
            margin-bottom: 20px; /* Space between input area and table */
            width: 100%;
            max-width: 1200px;
            box-sizing: border-box; /* Include padding in width */
            display: flex;
            flex-direction: column; /* Stack items vertically by default */
            gap: 15px; /* Increased space between input elements for visual separation */
        }
        .input-form-area .main-input-wrapper {
            flex-grow: 1;
        }
        .input-form-area .select-group {
            display: flex;
            gap: 10px; /* Space between the two selects */
        }
        .input-form-area .select-group > div {
            flex-basis: 50%; /* Each select wrapper takes half width */
            flex-grow: 1;
        }
        .input-form-area .submit-button-wrapper {
            display: flex;
            justify-content: flex-end; /* Align button to the right */
            margin-top: 10px; /* Space above the button */
        }
        .input-form-area button {
            background-color: #4299e1; /* Blue button */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .input-form-area button:hover {
            background-color: #3182ce; /* Darker blue on hover */
        }


        /* Adjust input elements within the form area to match screenshot's lighter look */
        .input-form-area .cell-input,
        .input-form-area .dropdown-cell select {
            border: 1px solid #d1d5db; /* Lighter border for clean look */
            background-color: #f9fafb; /* Very light background */
        }
        .input-form-area .dropdown-cell select {
            min-height: 38px; /* Match textarea/input height */
            padding-right: 30px; /* Space for custom arrow */
        }

        /* Mobile specific overrides */
        @media (max-width: 767px) {
            /* Table headers and data rows */
            thead .col-date,
            thead .col-time {
                display: table-cell; /* Ensure headers are visible on mobile */
            }
            td.col-date,
            td.col-time {
                display: table-cell; /* Ensure data cells are visible on mobile */
            }

            /* Adjust column widths for mobile data rows based on image */
            .col-description { width: 35%; }
            .col-date { width: 15%; }
            .col-time { width: 15%; }
            .col-reporter { width: 20%; }
            .col-journal { width: 15%; }

            /* Input form area specific mobile adjustments */
            .input-form-area {
                padding: 12px; /* Slightly less padding on very small screens */
                gap: 10px; /* Slightly less gap */
            }
            .input-form-area .main-input-wrapper {
                margin-bottom: 5px; /* Small space between textarea and selects group */
            }
            .input-form-area .select-group {
                flex-direction: row; /* Keep selects side by side */
                gap: 8px; /* Slightly less gap for selects */
            }
            .input-form-area .select-group > div {
                flex-basis: 50%;
            }
        }

        /* Tablet/Desktop adjustments (can inherit from default for some or override) */
        @media (min-width: 768px) { /* md breakpoint */
            .col-description { width: 25%; }
            .col-date { width: 15%; }
            .col-time { width: 15%; }
            .col-reporter { width: 25%; }
            .col-journal { width: 20%; }

            .input-form-area {
                flex-direction: column; /* Stack textarea on top, selects below */
                gap: 15px;
            }
        }

        @media (min-width: 1024px) { /* lg breakpoint */
            .col-description { width: 30%; }
            .col-date { width: 15%; }
            .col-time { width: 15%; }
            .col-reporter { width: 20%; }
            .col-journal { width: 20%; }
        }

        /* Loading indicator styling */
        .loading-indicator {
            display: none; /* Hidden by default */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            z-index: 1000;
        }
        .loading-indicator.show {
            display: block;
        }

        /* Error message styling */
        .error-message {
            display: none; /* Hidden by default */
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            width: 100%;
            max-width: 1200px;
            text-align: center;
            font-weight: bold;
        }
        .error-message.show {
            display: block;
        }

    </style>
</head>
<body class="bg-gray-100 p-4">
    <!-- Top left header as seen in the image, conceptually A1/A2 -->
    <div class="header-top-left" id="header-top-left">
        הערכת מצב בשעה 13:00
        <span class="cell-number">A2</span>
    </div>

    <!-- Error Message Display -->
    <div id="error-display" class="error-message">
        <p>שגיאה בחיבור ל-Firebase. אנא ודא שמפתח ה-API ומזהה הפרויקט הוגדרו נכון. אם אתה משתמש בפלטפורמת Canvas, ודא שאתה עובד בסביבה מתאימה.</p>
        <p>פרטים נוספים בקונסולה של הדפדפן.</p>
    </div>

    <!-- Separate input form area (Conceptual A3, D3, E3) -->
    <div class="input-form-area">
        <div class="main-input-wrapper">
            <textarea class="cell-input" id="inputA3" rows="1" placeholder="תיאור האירוע"></textarea>
        </div>
        <div class="select-group">
            <div>
                <div class="dropdown-cell">
                    <select class="reporter-name-select" id="inputD3">
                        <option value="">שם המדווח</option>
                        <option value="שונית">שונית</option>
                        <option value="אורי">אורי</option>
                        <option value="יעקב">יעקב</option>
                        <option value="משה">משה</option>
                    </select>
                </div>
            </div>
            <div>
                <div class="dropdown-cell">
                    <select class="journal-assignment-select" id="inputE3">
                        <option value="">שיוך יומן</option>
                        <option value="חרבות ברזל">חרבות ברזל</option>
                        <option value="תרגיל">תרגיל</option>
                        <option value="שריפה">שריפה</option>
                        <option value="שגרה">שגרה</option>
                        <option value="אחר">אחר</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="submit-button-wrapper">
            <button id="submitButton">הזן</button>
        </div>
    </div>

    <div class="table-container">
        <table class="min-w-full">
            <thead>
                <tr>
                    <!-- Row 2 (headers) -->
                    <th class="rounded-tr-lg col-description">
                        תיאור האירוע
                    </th>
                    <th class="col-date">
                        תאריך
                    </th>
                    <th class="col-time">
                        שעה
                    </th>
                    <th class="col-reporter">
                        שם המדווח
                    </th>
                    <th class="rounded-tl-lg col-journal">
                        שיוך יומן
                    </th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- Data rows will be dynamically loaded from Firestore -->
            </tbody>
        </table>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="loading-indicator">
        טוען נתונים...
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase (provided by Canvas environment)
        // Ensure that firebaseConfig has a projectId. If not provided by Canvas, use a fallback for testing.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Fallback for firebaseConfig if projectId or apiKey is missing (crucial for Uncaught FirebaseError)
        // Note: For actual deployment, replace "YOUR_API_KEY" and "YOUR_PROJECT_ID" with real Firebase project details.
        const defaultFirebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "default-project-id", // Use a placeholder if not provided by Canvas
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        if (!firebaseConfig.projectId || firebaseConfig.apiKey === "YOUR_API_KEY") {
            console.error("Firebase projectId or apiKey is missing/default. Using fallback configuration. Please ensure your Firebase project details are correctly configured.");
            firebaseConfig = { ...defaultFirebaseConfig, ...firebaseConfig }; // Merge to preserve any provided values
        }

        let app, db, auth;
        let isFirebaseInitialized = false;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            isFirebaseInitialized = true;
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Failed to initialize Firebase:", error);
            document.getElementById('error-display').classList.add('show'); // Show user-friendly error
            // Prevent further Firebase operations if initialization failed
        }


        let userId = null; // To store the authenticated user ID
        let isAuthReady = false; // Flag to indicate if auth state is known

        document.addEventListener('DOMContentLoaded', async () => {
            const tableBody = document.getElementById('table-body');
            const inputA3 = document.getElementById('inputA3');
            const inputD3 = document.getElementById('inputD3');
            const inputE3 = document.getElementById('inputE3');
            const submitButton = document.getElementById('submitButton'); // Get the new button
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorDisplay = document.getElementById('error-display');

            // Options for dropdowns
            const reporterNames = ["שונית", "אורי", "יעקב", "משה"];
            const journalAssignments = ["חרבות ברזל", "תרגיל", "שריפה", "שגרה", "אחר"];

            // Variable to store the last selected reporter and journal values
            let lastReporterValue = '';
            let lastJournalValue = '';

            // Function to show/hide loading indicator
            function showLoading(show) {
                if (show) {
                    loadingIndicator.classList.add('show');
                } else {
                    loadingIndicator.classList.remove('show');
                }
            }

            // Function to create a select element with given options
            function createSelectElement(options, selectedValue = '', className = '') {
                const select = document.createElement('select');
                select.className = className; // Add a class for easier targeting
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = ''; // Empty text for placeholder
                select.appendChild(emptyOption);

                options.forEach(optionText => {
                    const option = document.createElement('option');
                    option.value = optionText;
                    option.textContent = optionText;
                    if (optionText === selectedValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                return select;
            }

            // Function to auto-resize textarea based on content
            function autoResizeTextarea(textarea) {
                if (textarea) {
                    textarea.style.height = 'auto'; // Reset height to recalculate
                    textarea.style.height = (textarea.scrollHeight) + 'px'; // Set height to scrollHeight
                }
            }

            // Function to update cell numbers dynamically (excluding the input form area)
            function updateCellNumbers() {
                // Update header-top-left cell number (A2)
                const headerTopLeft = document.getElementById('header-top-left');
                let headerCellNumberSpan = headerTopLeft.querySelector('.cell-number');
                if (!headerCellNumberSpan) {
                    headerCellNumberSpan = document.createElement('span');
                    headerCellNumberSpan.className = 'cell-number';
                    headerTopLeft.appendChild(headerCellNumberSpan);
                }
                headerCellNumberSpan.textContent = 'A2';

                // Update cell numbers for table headers (row 2)
                const headerRow = document.querySelector('thead tr');
                const columnLetters = ['A', 'B', 'C', 'D', 'E'];
                Array.from(headerRow.children).forEach((th, colIndex) => {
                    let cellNumberSpan = th.querySelector('.cell-number');
                    if (!cellNumberSpan) {
                        cellNumberSpan = document.createElement('span');
                        cellNumberSpan.className = 'cell-number';
                        th.appendChild(cellNumberSpan);
                    }
                    // Headers are conceptually in row 2
                    cellNumberSpan.textContent = `${columnLetters[colIndex]}2`;
                });

                // Update cell numbers for data rows (starting from conceptual row 4, as A3 is the input form)
                const rows = tableBody.getElementsByTagName('tr');
                Array.from(rows).forEach((row, rowIndex) => {
                    // Data rows start from conceptual row 4 in the Excel sheet (after A2 header and A3 input form)
                    const conceptualRowNumber = rowIndex + 4;
                    Array.from(row.children).forEach((cell, colIndex) => {
                        let cellNumberSpan = cell.querySelector('.cell-number');
                        if (!cellNumberSpan) {
                            cellNumberSpan = document.createElement('span');
                            cellNumberSpan.className = 'cell-number';
                            cell.appendChild(cellNumberSpan);
                        }
                        cellNumberSpan.textContent = `${columnLetters[colIndex]}${conceptualRowNumber}`;
                    });
                });
            }

            // --- Firebase Authentication ---
            if (isFirebaseInitialized) {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User signed in:", userId);
                        isAuthReady = true;
                        setupFirestoreListener(); // Start listening to Firestore once authenticated
                    } else {
                        // Sign in anonymously if no user is found
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== null) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase auth error during anonymous sign-in:", error);
                            errorDisplay.classList.add('show'); // Show user-friendly error
                        }
                    }
                });
            } else {
                console.error("Firebase not initialized. Cannot proceed with authentication or Firestore operations.");
                errorDisplay.classList.add('show'); // Show user-friendly error
            }


            // --- Firestore Realtime Listener Setup ---
            function setupFirestoreListener() {
                if (!isAuthReady || !isFirebaseInitialized) {
                    console.warn("Auth not ready or Firebase not initialized, cannot set up Firestore listener.");
                    return;
                }

                showLoading(true);
                // Path for public data: /artifacts/{appId}/public/data/events
                const eventsCollectionRef = collection(db, `artifacts/${appId}/public/data/events`);
                const q = query(eventsCollectionRef, orderBy('timestamp', 'desc')); // Order by timestamp to get newest first

                onSnapshot(q, (snapshot) => {
                    tableBody.innerHTML = ''; // Clear current table content
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const row = document.createElement('tr');
                        row.dataset.id = doc.id; // Store Firestore document ID on the row

                        row.innerHTML = `
                            <td class="col-description"></td>
                            <td class="col-date"></td>
                            <td class="col-time"></td>
                            <td class="dropdown-cell col-reporter"></td>
                            <td class="dropdown-cell col-journal"></td>
                        `;

                        // Populate A column (description) with textarea
                        const descriptionTextarea = document.createElement('textarea');
                        descriptionTextarea.className = 'cell-input';
                        descriptionTextarea.value = data.description || '';
                        descriptionTextarea.rows = 1;
                        row.children[0].appendChild(descriptionTextarea);
                        autoResizeTextarea(descriptionTextarea); // Auto-resize immediately

                        // Populate B column (date) with input
                        const dateInput = document.createElement('input');
                        dateInput.type = 'text';
                        dateInput.className = 'cell-input';
                        dateInput.value = data.date || '';
                        row.children[1].appendChild(dateInput);

                        // Populate C column (time) with input
                        const timeInput = document.createElement('input');
                        timeInput.type = 'text';
                        timeInput.className = 'cell-input';
                        timeInput.value = data.time || '';
                        row.children[2].appendChild(timeInput);

                        // Populate D column (reporter) with select
                        row.children[3].appendChild(createSelectElement(reporterNames, data.reporter || '', 'reporter-name-select'));

                        // Populate E column (journal) with select
                        row.children[4].appendChild(createSelectElement(journalAssignments, data.journal || '', 'journal-assignment-select'));

                        tableBody.appendChild(row);
                    });
                    updateCellNumbers(); // Update cell numbers after all rows are rendered
                    showLoading(false);
                }, (error) => {
                    console.error("Error listening to Firestore:", error);
                    showLoading(false);
                    // Optionally display an error message to the user
                    errorDisplay.classList.add('show'); // Show user-friendly error
                });
            }


            // --- Function to handle submission logic (used by both Enter in textarea and Submit button) ---
            async function handleSubmit() {
                console.log("handleSubmit triggered."); // Log when function is called
                showLoading(true);

                // Ensure Firebase is ready before attempting Firestore operations
                if (!isAuthReady || !isFirebaseInitialized || !db || !auth || !userId) {
                    console.error("Firebase is not fully initialized or authenticated. isAuthReady:", isAuthReady, "isFirebaseInitialized:", isFirebaseInitialized, "userId:", userId);
                    showLoading(false);
                    errorDisplay.classList.add('show'); // Show user-friendly error
                    return;
                }
                console.log("Firebase is ready. Proceeding with submission.");

                const enteredText = inputA3.value;
                const reporterNameValue = inputD3.value; // Get value from D3 select in the form area
                const journalAssignmentValue = inputE3.value; // Get value from E3 select in the form area

                // Only proceed if description is not empty
                if (enteredText.trim() === '') {
                    console.warn("תיאור האירוע לא יכול להיות ריק. (Description cannot be empty)");
                    showLoading(false);
                    return;
                }

                const now = new Date();
                const date = now.toLocaleDateString('he-IL');
                const time = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                const eventData = {
                    description: enteredText,
                    date: date,
                    time: time,
                    reporter: reporterNameValue,
                    journal: journalAssignmentValue,
                    timestamp: serverTimestamp() // Firestore server timestamp for ordering
                };

                try {
                    // Add the new event data to Firestore
                    const eventsCollectionRef = collection(db, `artifacts/${appId}/public/data/events`);
                    await addDoc(eventsCollectionRef, eventData);
                    console.log("Document successfully written to Firestore!");

                    // Clear the input form area A3 textarea
                    inputA3.value = '';
                    autoResizeTextarea(inputA3); // Reset textarea height

                    // Update last selected values for D3 and E3
                    lastReporterValue = reporterNameValue;
                    lastJournalValue = journalAssignmentValue;

                    // Set the D3 and E3 selects in the input form area to the last selected values
                    inputD3.value = lastReporterValue;
                    inputE3.value = lastJournalValue;

                    inputA3.focus(); // Focus back on A3
                } catch (error) {
                    console.error("Error adding document to Firestore: ", error);
                    errorDisplay.classList.add('show'); // Show user-friendly error
                } finally {
                    showLoading(false);
                }
            }


            // --- Event Listeners ---
            // Allow Enter key to create new lines in A3 textarea (Shift+Enter)
            // Or submit on plain Enter
            inputA3.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault(); // Prevent default Enter (which is newline in textarea)
                    handleSubmit();
                }
            });

            // Handle submission when the "הזן" button is clicked
            submitButton.addEventListener('click', handleSubmit);

            // Auto-resize the initial inputA3 on load
            autoResizeTextarea(inputA3);

            // Set initial values for D3 and E3 selects if they are empty
            // This happens on page load or if values weren't set by lastReporterValue/lastJournalValue
            // (e.g., first load of the app without prior submission)
            // Note: This logic might need refinement if 'lastReporterValue' / 'lastJournalValue'
            // are expected to persist across sessions (e.g., using localStorage).
            // For now, they reset on page load.
            if (inputD3.value === '' && lastReporterValue !== '') {
                inputD3.value = lastReporterValue;
            }
            if (inputE3.value === '' && lastJournalValue !== '') {
                inputE3.value = lastJournalValue;
            }
        });
    </script>
</body>
</html>
